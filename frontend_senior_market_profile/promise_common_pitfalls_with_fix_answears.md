## Promise å‘ä½çš„å·¥ç¨‹æ›¿ä»£æ–¹æ¡ˆï¼ˆåŸæ–‡æ‘˜å½•ï¼‰

---

### 1ï¸âƒ£ ç”Ÿå‘½å‘¨æœŸå¤±æ§ï¼ˆè¯·æ±‚ä¸ç»„ä»¶ç”Ÿå‘½å‘¨æœŸè„±é’©ï¼‰

**å‘çš„æœ¬è´¨**

#### ä»£ç ç¤ºä¾‹ï¼šé—®é¢˜æ˜¯å¦‚ä½•å‘ç”Ÿçš„

**âŒ å…¸å‹é”™è¯¯å†™æ³•ï¼ˆPromise ä¸ç»„ä»¶ç”Ÿå‘½å‘¨æœŸè„±é’©ï¼‰**

```tsx
function Profile() {
  const [user, setUser] = useState(null)

  useEffect(() => {
    fetchUser().then((data) => {
      setUser(data) // âš ï¸ ç»„ä»¶å¯èƒ½å·²ç»å¸è½½
    })
  }, [])

  return <div>{user?.name}</div>
}
```

**é—®é¢˜è¯´æ˜**

- `fetchUser()` è¿”å›ä¸€ä¸ª Promise
- Promise åˆ›å»ºåï¼Œä¸ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ**å®Œå…¨æ— å…³**
- å¦‚æœç»„ä»¶åœ¨è¯·æ±‚å®Œæˆå‰å¸è½½ï¼š
  - Promise ä»ä¼š resolve
  - `setUser` ä»ä¼šæ‰§è¡Œ
  - React ä¼šè­¦å‘Šï¼š*Can't perform a React state update on an unmounted component*

---

**âš ï¸ æ‰‹å†™ AbortController çš„å±€é™**

```tsx
useEffect(() => {
  const controller = new AbortController()

  fetch(url, { signal: controller.signal })
    .then((res) => res.json())
    .then(setUser)

  return () => {
    controller.abort()
  }
}, [])
```

- åªèƒ½â€œå°è¯•å–æ¶ˆè¯·æ±‚â€
- æ— æ³•ä¿è¯ï¼š
  - çŠ¶æ€æ˜¯å¦å·²ç»è¢«éƒ¨åˆ†æ›´æ–°
  - å¤šä¸ªå¹¶å‘è¯·æ±‚ä¹‹é—´çš„ç»“æœä¸€è‡´æ€§

**å·¥ç¨‹æ›¿ä»£æ–¹æ¡ˆ**

âœ… **React Query**

- Query ç”Ÿå‘½å‘¨æœŸç”±ç»„ä»¶è®¢é˜…å…³ç³»æ§åˆ¶
- ç»„ä»¶å¸è½½ â†’ è‡ªåŠ¨å–æ¶ˆè®¢é˜… â†’ ç»“æœä¸ä¼šå†å½±å“ UI

#### React Query å¦‚ä½•é¿å…è¯¥é—®é¢˜

```tsx
function Profile() {
  const { data } = useQuery({
    queryKey: ['user'],
    queryFn: fetchUser,
  })

  return <div>{data?.name}</div>
}
```

**å…³é”®ç‚¹**

- Query çš„ç”Ÿå‘½å‘¨æœŸç”±â€œæ˜¯å¦æœ‰ç»„ä»¶åœ¨è®¢é˜…â€å†³å®š
- ç»„ä»¶å¸è½½ï¼š
  - è‡ªåŠ¨å–æ¶ˆè®¢é˜…
  - å³ä½¿è¯·æ±‚å®Œæˆï¼Œç»“æœä¹Ÿä¸ä¼šå†é©±åŠ¨ UI
- å¼€å‘è€…æ— éœ€æ‰‹åŠ¨åˆ¤æ–­ç»„ä»¶æ˜¯å¦è¿˜å­˜åœ¨

âœ… **AbortControllerï¼ˆåº•å±‚å…œåº•ï¼‰**

- åªèƒ½è§£å†³â€œå–æ¶ˆè¯·æ±‚â€
- è§£å†³ä¸äº†çŠ¶æ€ä¸€è‡´æ€§é—®é¢˜

---

### 2ï¸âƒ£ çŠ¶æ€çˆ†ç‚¸ï¼ˆloading / error / success æ‰‹å†™åœ°ç‹±ï¼‰

**å‘çš„æœ¬è´¨**

- Promise åªè¿”å›å€¼ / æŠ›å¼‚å¸¸
- UI éœ€è¦çš„çŠ¶æ€è¿œå¤šäº Promise è¡¨è¾¾èƒ½åŠ›

#### çœŸå®ä¸šåŠ¡åœºæ™¯ï¼šé¡µé¢åŠ è½½ç”¨æˆ·èµ„æ–™

éœ€æ±‚ï¼š
- é¦–æ¬¡åŠ è½½å±•ç¤º loading
- æˆåŠŸå±•ç¤ºæ•°æ®
- å¤±è´¥å±•ç¤ºé”™è¯¯
- åˆ·æ–°æ—¶åŒºåˆ†ã€Œé¦–æ¬¡ loadingã€å’Œã€Œåå°åˆ·æ–°ã€

âŒ Promise + useState çš„å…¸å‹å†™æ³•

```tsx
function Profile() {
  const [data, setData] = useState(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<Error | null>(null)

  const load = async () => {
    setLoading(true)
    setError(null)

    try {
      const res = await fetchUser()
      setData(res)
    } catch (e) {
      setError(e as Error)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    load()
  }, [])

  if (loading) return <Loading />
  if (error) return <ErrorView />
  return <ProfileView data={data} />
}
```

é—®é¢˜ï¼š
- loading / error / data å¼ºè€¦åˆ
- æ— æ³•åŒºåˆ†ã€Œé¦–æ¬¡åŠ è½½ã€ä¸ã€Œåå°åˆ·æ–°ã€
- æ¯åŠ ä¸€ä¸ªçŠ¶æ€ï¼Œé€»è¾‘å¤æ‚åº¦æŒ‡æ•°çº§ä¸Šå‡

**å·¥ç¨‹æ›¿ä»£æ–¹æ¡ˆ**

âœ… **React Query**

- å†…å»º `status / isLoading / isFetching / isError`
- çŠ¶æ€æ˜¯â€œæ¨¡å‹â€ï¼Œä¸æ˜¯ä¸´æ—¶å¸ƒå°”å˜é‡

#### React Query çš„è§£å†³æ–¹å¼ï¼šçŠ¶æ€æ¨¡å‹åŒ–

```tsx
function Profile() {
  const {
    data,
    status,
    isLoading,
    isFetching,
    isError,
  } = useQuery({
    queryKey: ['user'],
    queryFn: fetchUser,
  })

  if (isLoading) return <Loading />
  if (isError) return <ErrorView />

  return (
    <>
      {isFetching && <BackgroundSpinner />}
      <ProfileView data={data} />
    </>
  )
}
```

å·¥ç¨‹ä¼˜åŠ¿ï¼š
- çŠ¶æ€ä¸æ˜¯å¸ƒå°”æ‹¼è£…ï¼Œè€Œæ˜¯**å†…å»ºæ¨¡å‹**
- isLoading â‰  isFetchingï¼ˆé¦–æ¬¡ vs åå°åˆ·æ–°ï¼‰
- UI åªåšæ˜ å°„ï¼Œä¸å‚ä¸çŠ¶æ€æ¨å¯¼

âœ… **XState**

- æ˜¾å¼çŠ¶æ€å›¾
- æ¯ä¸ªçŠ¶æ€éƒ½æœ‰åˆæ³•å‡ºå£

#### XState çš„è§£å†³æ–¹å¼ï¼šçŠ¶æ€æ˜¾å¼å»ºæ¨¡

```ts
const profileMachine = createMachine({
  id: 'profile',
  initial: 'loading',
  states: {
    loading: {
      invoke: {
        src: 'fetchUser',
        onDone: { target: 'success' },
        onError: { target: 'failure' },
      },
    },
    success: {
      on: { REFRESH: 'loading' },
    },
    failure: {
      on: { RETRY: 'loading' },
    },
  },
})
```

å·¥ç¨‹ä¼˜åŠ¿ï¼š
- çŠ¶æ€ç©ºé—´æ˜¯**æœ‰é™ä¸”å¯æšä¸¾çš„**
- ä¸å­˜åœ¨ã€Œéæ³•ä¸­é—´æ€ã€
- å¤æ‚ä¸šåŠ¡ä¸‹å¯é¢„æµ‹ã€å¯æ¨æ¼”

ä»¥ä¸‹å¯¹æ¯”æ€»ç»“çš„æ˜¯ï¼šå½“çŠ¶æ€å¤æ‚åº¦ä¸Šå‡æ—¶ï¼Œä¸åŒæ–¹æ¡ˆçš„å¯ç»´æŠ¤æ€§å·®å¼‚ã€‚

---


### 3ï¸âƒ£ é‡å¤è¯·æ±‚ä¸å»é‡å¤±è´¥ï¼ˆå¹¶å‘é£æš´çš„çœŸå®æ¥æºï¼‰

#### 1ï¸âƒ£ çœŸå®ä¸šåŠ¡åœºæ™¯

**å…¸å‹åœºæ™¯ Aï¼šå¤šä¸ªç»„ä»¶åŒæ—¶è¯·æ±‚åŒä¸€ä»½æ•°æ®**

```tsx
function UserProfile() {
  useEffect(() => {
    fetchUser()
  }, [])
}

function UserSidebar() {
  useEffect(() => {
    fetchUser()
  }, [])
}
```

- é¡µé¢é¦–æ¬¡æ¸²æŸ“
- `UserProfile` ä¸ `UserSidebar` åŒæ—¶æŒ‚è½½
- **åŒä¸€ä¸ªæ¥å£è¢«è¯·æ±‚ä¸¤æ¬¡**

---

**å…¸å‹åœºæ™¯ Bï¼šåŒä¸€ç»„ä»¶è¢«é¢‘ç¹è§¦å‘**

```tsx
<button onClick={loadUser}>Refresh</button>
```

- ç”¨æˆ·è¿ç»­ç‚¹å‡»
- æˆ–è€…æ»šåŠ¨ / focus / reconnect ç­‰äº‹ä»¶
- åŒä¸€ä¸ªè¯·æ±‚è¢«çŸ­æ—¶é—´å†…å¤šæ¬¡è§¦å‘

---

#### 2ï¸âƒ£ æ‰‹å†™ Promise èƒ½åšä»€ä¹ˆï¼Ÿä¸èƒ½åšä»€ä¹ˆï¼Ÿ

**âŒ å¸¸è§ Promise å†™æ³•**

```ts
let cache: any = null

function fetchUserOnce() {
  if (cache) return Promise.resolve(cache)

  return fetch('/api/user')
    .then(res => res.json())
    .then(data => {
      cache = data
      return data
    })
}
```

**è¡¨é¢ä¸Šè§£å†³äº†ä»€ä¹ˆï¼Ÿ**

- å‹‰å¼ºåšåˆ°äº†ã€Œç®€å•ç¼“å­˜ã€

**ä½†è§£å†³ä¸äº†ä»€ä¹ˆï¼Ÿ**

- âŒ å¹¶å‘åŒæ—¶è¿›å…¥æ—¶ï¼Œ`cache` ä»ä¸ºç©º â†’ è¯·æ±‚ç…§æ ·å‘å¤šæ¬¡
- âŒ æ— æ³•å¤„ç†ï¼š
  - ç»„ä»¶å¸è½½
  - é”™è¯¯é‡è¯•
  - ç¼“å­˜å¤±æ•ˆ
  - åå°åˆ·æ–°
- âŒ çŠ¶æ€å®Œå…¨ä¸å¯è§‚æµ‹ï¼ˆloading / error / successï¼‰

ğŸ‘‰ **Promise åªèƒ½â€œä¸²è¡Œç­‰å¾…â€ï¼Œä¸èƒ½åšâ€œå¹¶å‘åè°ƒâ€**

---

#### 3ï¸âƒ£ React Query å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

**æ ¸å¿ƒæ€æƒ³ï¼š**

> æŠŠã€Œè¯·æ±‚ã€æå‡ä¸º**å…¨å±€å¯åè°ƒçš„èµ„æº**
> è€Œä¸æ˜¯ç»„ä»¶é‡Œçš„ä¸€æ¬¡æ€§ Promise

---

**React Query å†™æ³•**

```tsx
function useUser() {
  return useQuery({
    queryKey: ['user'],
    queryFn: fetchUser,
  })
}
```

å¤šä¸ªç»„ä»¶ä½¿ç”¨ï¼š

```tsx
function UserProfile() {
  const { data } = useUser()
  return <div>{data?.name}</div>
}

function UserSidebar() {
  const { data } = useUser()
  return <div>{data?.role}</div>
}
```

---

#### 4ï¸âƒ£ ä¸ºä»€ä¹ˆ `queryKey` å¯ä»¥â€œå®Œç¾è§£å†³â€ï¼Ÿ

**`queryKey` çš„å·¥ç¨‹å«ä¹‰ä¸æ˜¯å‚æ•°ï¼Œè€Œæ˜¯ï¼š**

> **è¿™æ˜¯ä¸€ä¸ªâ€œèµ„æºçš„å”¯ä¸€èº«ä»½æ ‡è¯†â€**

---

React Query å†…éƒ¨åšäº†ä»€ä¹ˆï¼ˆæ¦‚å¿µå±‚ï¼‰ï¼š

```ts
if (queryCache.has(queryKey)) {
  return existingQuery
} else {
  createNewQuery(queryKey, queryFn)
}
```

å¸¦æ¥çš„å·¥ç¨‹æ•ˆæœï¼š

- âœ… ç›¸åŒ `queryKey`ï¼š
  - æ‰€æœ‰ç»„ä»¶**å…±äº«åŒä¸€ä¸ªè¯·æ±‚å®ä¾‹**
  - å¹¶å‘åªä¼šçœŸæ­£å‘ä¸€æ¬¡è¯·æ±‚
- âœ… åæ¥çš„è®¢é˜…è€…ï¼š
  - ç›´æ¥å¤ç”¨è¿›è¡Œä¸­çš„ Promise
- âœ… è¯·æ±‚å®Œæˆï¼š
  - æ‰€æœ‰è®¢é˜…ç»„ä»¶åŒæ—¶æ›´æ–°

---

#### 5ï¸âƒ£ å¹¶å‘åœºæ™¯ä¸‹çš„è¡Œä¸ºå¯¹æ¯”æ€»ç»“

| åœºæ™¯ | æ‰‹å†™ Promise | React Query |
|----|-------------|-------------|
| å¤šç»„ä»¶åŒæ—¶è¯·æ±‚ | âŒ å¤šæ¬¡è¯·æ±‚ | âœ… è‡ªåŠ¨å»é‡ |
| å¹¶å‘è¯·æ±‚åè°ƒ | âŒ æ—  | âœ… å†…å»º |
| è¯·æ±‚çŠ¶æ€å…±äº« | âŒ æ—  | âœ… |
| é”™è¯¯ç»Ÿä¸€å¤„ç† | âŒ åˆ†æ•£ | âœ… |
| ç¼“å­˜å¤ç”¨ | âš ï¸ å‹‰å¼º | âœ… |

---

#### 6ï¸âƒ£ å·¥ç¨‹ç»“è®º

- **é‡å¤è¯·æ±‚ä¸æ˜¯â€œå†™ä¸å†™ Promise çš„é—®é¢˜â€**
- è€Œæ˜¯ï¼š
  > æ˜¯å¦å­˜åœ¨ä¸€ä¸ª**å…¨å±€å¯åè°ƒçš„è¯·æ±‚æ¨¡å‹**

å½“ä½ å¼€å§‹å…³å¿ƒï¼š
- å»é‡
- å¹¶å‘
- çŠ¶æ€å…±äº«
- ç”Ÿå‘½å‘¨æœŸ

ğŸ‘‰ å°±å·²ç»è¶…å‡ºäº† Promise çš„èƒ½åŠ›è¾¹ç•Œ  
ğŸ‘‰ å¿…é¡»è¿›å…¥ **å·¥ç¨‹çº§è§£å†³æ–¹æ¡ˆ**

---

---

### 4ï¸âƒ£ ç¼“å­˜ä¸è¿‡æœŸé€»è¾‘ä¸å¯ç»´æŠ¤

**å‘çš„æœ¬è´¨**

- Promise ä¸å…³å¿ƒâ€œæ˜¯å¦è¿˜æ–°é²œâ€
- æ‰‹å†™ç¼“å­˜ææ˜“å¼•å…¥éšæ€§ bug

**å·¥ç¨‹æ›¿ä»£æ–¹æ¡ˆ**

âœ… **React Query**

- `staleTime` / `gcTime`
- åå°åˆ·æ–° + å‰å°ç«‹å³å¯ç”¨

---

### 5ï¸âƒ£ æœç´¢ç«æ€ï¼ˆPromise æœ€å®¹æ˜“èƒŒé”…çš„åœ°æ–¹ï¼‰

**å‘çš„æœ¬è´¨**

- Promise æ— æ³•è¡¨è¾¾â€œè°åº”è¯¥è¢«ä¸¢å¼ƒâ€
- åå‘è¯·æ±‚ â‰  åè¿”å›

**å·¥ç¨‹æ›¿ä»£æ–¹æ¡ˆ**

âœ… **React Query**

- key å˜åŒ– â†’ è‡ªåŠ¨å–æ¶ˆæ—§è¯·æ±‚
- çŠ¶æ€æ°¸è¿œä»¥ â€œæœ€åä¸€æ¬¡ keyâ€ ä¸ºå‡†

```ts
useQuery(['search', keyword], fetchSearch)
```

âœ… **Google Searchï¼ˆäº§å“çº§æ–¹æ¡ˆï¼‰**

> æœç´¢é—®é¢˜ä¸æ˜¯çº¯æŠ€æœ¯é—®é¢˜ï¼Œè€Œæ˜¯äº§å“ + æ¶æ„é—®é¢˜

- åŒ¹é…å€™é€‰è¯
- è€Œä¸æ˜¯åŒ¹é…ç»“æœ
- ä»æ ¹ä¸Šè§„é¿ç«æ€

âœ… **XStateï¼ˆç«æ€æ˜¾å¼å»ºæ¨¡ï¼‰**

- ç”¨çŠ¶æ€æœºæŠŠâ€œè¾“å…¥ â†’ è¯·æ±‚ â†’ æˆåŠŸ / å¤±è´¥ / å–æ¶ˆâ€æ˜¾å¼åŒ–
- ç«æ€é çŠ¶æ€çº¦æŸï¼Œè€Œä¸æ˜¯ Promise è¿æ°”

---

### 6ï¸âƒ£ é”™è¯¯é‡è¯• / å›é€€ç­–ç•¥å¤±æ§

**å‘çš„æœ¬è´¨**

- Promise å¤±è´¥å³å¤±è´¥
- é‡è¯• / å›é€€é€»è¾‘åªèƒ½å¤–åŒ…ç»™è°ƒç”¨è€…

**å·¥ç¨‹æ›¿ä»£æ–¹æ¡ˆ**

âœ… **React Query**

- å†…å»º retry / backoff
- å¯åŒºåˆ†ç½‘ç»œé”™è¯¯ / ä¸šåŠ¡é”™è¯¯

âœ… **XState**

- é”™è¯¯æ˜¯çŠ¶æ€ï¼Œä¸æ˜¯å¼‚å¸¸
- å›é€€è·¯å¾„å¯è¢«å»ºæ¨¡å’ŒéªŒè¯

---

## æ€»ç»“ï¼šPromise ä¸å·¥ç¨‹æ–¹æ¡ˆèƒ½åŠ›å¯¹æ¯”

| ç»´åº¦ | Promise | React Query | XState |
|----|--------|-------------|--------|
| ç”Ÿå‘½å‘¨æœŸç®¡ç† | âŒ | âœ… | âœ… |
| å¹¶å‘å»é‡ | âŒ | âœ… | âš ï¸ï¼ˆéœ€å»ºæ¨¡ï¼‰ |
| ç«æ€å¤„ç† | âŒ | âœ… | âœ… |
| ç¼“å­˜ / è¿‡æœŸ | âŒ | âœ… | âŒ |
| çŠ¶æ€è¡¨è¾¾èƒ½åŠ› | âŒ | âœ… | âœ… |
| é€‚åˆå¤æ‚ä¸šåŠ¡ | âŒ | âš ï¸ | âœ… |

> ç»“è®ºï¼š
> Promise æ˜¯**è¯­æ³•å·¥å…·**ï¼Œä¸æ˜¯**å·¥ç¨‹è§£æ³•**ã€‚  
> ä¸€æ—¦è¿›å…¥å¹¶å‘ / çŠ¶æ€ / ç”Ÿå‘½å‘¨æœŸé¢†åŸŸï¼Œå¿…é¡»å‡çº§å·¥ç¨‹æ¨¡å‹ã€‚
